(function(){"use strict";const b=Object.freeze({int8:Int8Array,uint8:Uint8Array,int16:Int16Array,uint16:Uint16Array,int32:Int32Array,uint32:Uint32Array,int64:BigInt64Array,uint64:BigUint64Array,float32:Float32Array,float64:Float64Array,uint8Clamped:Uint8ClampedArray}),d=Object.getPrototypeOf(Uint8Array),R=d.prototype,k=l=>l instanceof d,A=new Map,T=new Map,I=l=>A.has(l);for(const[l,t]of Object.entries(b))T.set(t,l),A.set(l,t);const{call:j}=Function.prototype,g=(l,t)=>l*t,x=j.bind(R.subarray);class f extends Array{static isNdarray(t,r,e){return t instanceof f?e==null?t.ndim===r:t.ndim===r&&t.buffer instanceof b[e]:t instanceof d?e==null?r===1:r===1&&t instanceof b[e]:!1}static*xreshape(t,r,e){const n=r.slice(1),s=n.reduce(g,1),i=r[0];let a=0;for(;a<i&&e<t.length;a++,e+=s)yield this._reshape(t,n,e)}static _reshape(t,r,e){if(r.length>1){const n=f.from(f.xreshape(t,r,e));return n.buffer=t,n.shape=Object.freeze(r),n.offset=e,Object.freeze(n)}else return e===0&&r[0]===t.length?t:x(t,e,e+r[0])}static create(t,r,e=0){typeof r=="string"?r=r.split(",").map(Number):typeof r=="number"&&(r=[r]);let n,s;return I(t)?(n=b[t],s=new n(r.reduce(g,1)),e=0):k(t)?s=t:(n=t,s=new n(r.reduce(g,1)),e=0),this._reshape(s,r,e)}constructor(t){super(t)}get ndim(){return this.shape.length}slice(t=0,r=this.length){return f.unpack(f.pack(this.subarray(t,r)))}subarray(t=0,r=this.length){t<0&&(t+=this.length);let e=super.slice(t,r);e.buffer=this.buffer;let n=this.shape.slice();return n[0]=e.length,e.shape=Object.freeze(n),e.offset=this.offset+t*n.slice(1).reduce(g,1),Object.freeze(e)}reshape(t){return arguments.length>1&&(t=[...arguments]),f.create(this.buffer,t,this.offset)}toBuffer(){const{buffer:t,shape:r,offset:e}=this,n=r.reduce(g);return e===0&&n===t.length?t:x(t,e,e+n)}static pack(t){let r,e;k(t)?(r=t,e=[r.length]):(r=t.toBuffer(),e=t.shape.slice());const{buffer:n,byteOffset:s,byteLength:i,constructor:a}=r;return{shape:e,dtype:T.get(a),buffer:new Uint8Array(n,s,i)}}static unpack(t){const{buffer:r,shape:e,dtype:n}=t,{byteOffset:s,byteLength:i}=r,a=A.get(n);return this.create(new a(r.buffer.slice(s,s+i)),e)}}Object.assign(f.prototype,{[Symbol.toStringTag]:f.name});let m,E,F,z;(async()=>{try{m=WebAssembly,E=m.compileStreaming,F=m.instantiate,m.Module.imports(await E(fetch("data:application/wasm;base64,AGFzbQEAAAA"))),z=!0}catch(l){throw z=!1,l}})();const w=l=>{if(l<0)throw new RangeError("invalid number")},{min:B}=Math,_=8,C=28,L=58;class p{#e;#t=0;#r;get buffer(){return this.#e}get pos(){return this.#t}get size(){return this.#r}constructor(t){typeof t=="number"?(this.#e=new Uint8Array(t),this.#r=0):(this.#e=new Uint8Array(t),this.#r=this.#e.byteLength)}#s(t){const r=this.#e.length;if(t>r){let e=r;e<1&&(e=8);do e+=B(e,65536);while(t>e);let n=this.#e;this.#e=new Uint8Array(e),this.#e.set(n)}}read(t){let{buffer:r}=t,e=0,n=this.#t;for(let s=0,i=t.length;s<i;s+=2){let a=t[s],o=t[s+1],h=new Uint8Array(r,a,o);if(n+=o,n>this.#r){h.set(new Uint8Array(this.#e.buffer,this.#t,this.#r-this.#t)),e+=this.#r-this.#t,this.#t=this.#r;break}h.set(new Uint8Array(this.#e.buffer,this.#t,o)),this.#t=n,e+=o}return e}write(t){let{buffer:r}=t,e=0,n=this.#t;for(let s=0,i=t.length;s<i;s+=2){let a=t[s],o=t[s+1];n+=o,n>this.#r&&(this.#r=n),this.#s(n),this.#e.set(new Uint8Array(r,a,o),this.#t),this.#t=n,e+=o}return e}seek(t,r){let e;switch(r){case 0:e=t;break;case 1:e=this.#t+t;break;case 2:e=this.#r+t;break;default:return-1}return e>=0&&(this.#t=e),e}getData(){return new Uint8Array(this.#e.buffer,0,this.#r)}getText(){return new TextDecoder().decode(new Uint8Array(this.#e.buffer,0,this.#r))}}let U=null,O;class M{static{O=async t=>{const r=await F(t,{wasi_snapshot_preview1:{fd_read(s,i,a,o){const h=e.buffer,c=n.#r[s];if(c==null)return _;let u=c.read(new Uint32Array(h,i>>>0,a*2));return new Uint32Array(h,o,1)[0]=u,0},fd_write(s,i,a,o){const h=e.buffer,c=n.#r[s];if(c==null)return _;let u=c.write(new Uint32Array(h,i>>>0,a*2));return new Uint32Array(h,o,1)[0]=u,0},fd_seek(s,i,a,o){const h=e.buffer,c=n.#r[s];if(c==null)return _;let u=c.seek(Number(i),a);return u<0?C:(new BigUint64Array(h,o>>>0,1)[0]=BigInt(u),0)},fd_fdstat_get(s,i){const a=e.buffer;return new Uint8Array(a,i,1)[0]=s>2?4:2,0},fd_fdstat_set_flags(s,i){return L},fd_close(s){const i=n.#r[s];return i==null?_:(i.seek(0,0),0)},proc_exit(s){throw new Error("exit with exit code "+s)}},env:{constructNotify(s){n.#s[n.#s.length]=s},readFloat64Array(s,i,a){const o=e.buffer;new Float64Array(o,i>>>0,a).set(n.#t[s])},writeFloat64Array(s,i,a){const o=e.buffer;(n.#t[s]=new Float64Array(+a)).set(new Float64Array(o,i>>>0,a))},readFloat64Array2D(s,i,a,o){const h=e.buffer,c=new Uint32Array(h,i>>>0,a),u=n.#t[s];let y=0;for(;y<a;y++)new Float64Array(h,c[y],o).set(u[y])},writeFloat64Array2D(s,i,a,o){const h=e.buffer,c=new Uint32Array(h,i>>>0,a),u=n.#t[s]=f.create("float64",[a,o]);let y=0;for(;y<a;y++)u[y].set(new Float64Array(h,c[y],o))},emscripten_notify_memory_growth(s){}}}),e=r.exports.memory;U=r;const n=new M(r);return U=null,n}}#e;#t;#r;#s=[];constructor(t){if(U!==t)throw new TypeError("Illegal constructor.");this.#e=t.exports,this.#t=null,this.#r=null,this.#e._initialize()}get memorySize(){return this.#e.memory.buffer.byteLength}about(){try{return this.#r=[null,new p(8)],this.#e._get_info(),this.#r[1].getText().trim()}finally{this.#r=null}}#i(t,r=0,e=0){this.#e._init_world(t,r,e)}#n(){this.#t=null,this.#r=null;for(const t of this.#s)this.#e._destruct(t);this.#s=[]}dio(t,r,e=5,n=!1){const s=t.length;try{return this.#t=[t],this.#i(r),w(this.#e._dio(s,r,e,n?1:0)),{f0:this.#t[2],time_axis:this.#t[1]}}finally{this.#n()}}harvest(t,r,e=5,n=!1){const s=t.length;try{return this.#t=[t],this.#i(r),w(this.#e._harvest(s,r,e,n?1:0)),{f0:this.#t[2],time_axis:this.#t[1]}}finally{this.#n()}}stonemask(t,r,e,n){const s=t.length,i=r.length;try{return this.#t=[t,e,r],w(this.#e._stonemask(s,n,i)),this.#t[2]}finally{this.#n()}}cheaptrick(t,r,e,n){const s=t.length,i=r.length;try{this.#t=[t,e,r],this.#i(n);const a=this.#e._cheaptrick(s,n,i);return w(a),{spectrogram:this.#t[3],fft_size:a}}finally{this.#n()}}d4c(t,r,e,n,s=0){const i=t.length,a=r.length;try{return this.#t=[t,e,r],this.#i(n),w(this.#e._d4c(i,n,a,s)),{aperiodicity:this.#t[4]}}finally{this.#n()}}wav2world(t,r,e=5){const{f0:n,time_axis:s}=this.dio(t,r,e),i=this.stonemask(t,n,s,r),{spectrogram:a,fft_size:o}=this.cheaptrick(t,i,s,r),{aperiodicity:h}=this.d4c(t,i,s,r);return{time_axis:s,f0:i,fft_size:o,spectrogram:a,aperiodicity:h}}synthesis(t,r,e,n,s=5){const i=t.length;try{if(i!=r.shape[0]||i!=e.shape[0])throw new TypeError(`Mismatched number of frames between F0 (${i}), spectrogram (${r.shape[0]}) and aperiodicty (${e.shape[0]})`);if(r.shape[1]!=e.shape[1])throw new TypeError(`Mismatched dimensionality (spec size) between spectrogram (${r.shape[1]}) and aperiodicity (${e.shape[1]})`);return this.#t=[null,null,t,r,e],w(this.#e._synthesis(i,(r.shape[1]-1)*2,n,s)),this.#t[0]}finally{this.#n()}}wavread(t){try{this.#t=[null],this.#r=[null,new p(8),null,new p(t)];const r=this.#e._wavreadlength();if(r>0){const e=this.#e._wavread(r);if(e>0){const n=this.#t[0],s=this.#t[1];return{x:n,fs:e,nbit:s[1]}}}throw new TypeError(this.#r[1].getText().trim()||"Unknown Error")}finally{this.#n()}}wavwrite(t,r){try{this.#t=[t],this.#r=[null,new p(8),null,new p(256)],this.#e._wavwrite(t.length,r);const e=this.#r[3];if(e.size>0)return new Blob([e.getData()],{type:"audio/wave"});throw new TypeError(this.#r[1].getText().trim()||"Unknown Error")}finally{this.#n()}}}self.addEventListener("message",async l=>{try{const{data:t}=l,r=Function(`'use strict';return (${t.functionToRun})`)(),e=await O(t.module);let[n,s]=await r({Ndarray:f,world:e},t.args);postMessage(n,s)}catch(t){try{postMessage({error:t??"Unknown Error"});return}catch{}try{let{name:r,message:e,stack:n}=t;e??="Unknown Error",postMessage({error:{name:r,message:e,stack:n}});return}catch{}postMessage({error:{message:"Unknown Error"}})}},{once:!0})})();
